name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'pnpm'
    
    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: latest
        run_install: true

    - name: Run Unit Tests
      run: pnpm test
      env:
        JWT_SECRET: 'test-secret-key-at-least-32-chars-long-for-ci'
        DATABASE_URL: 'mysql://root:password@localhost:3306/newswindon'
        EMAIL_HOST: 'smtp.gmail.com'
        EMAIL_PORT: '587'
        EMAIL_SECURE: 'false'
        EMAIL_USER: 'test@gmail.com'
        EMAIL_PASSWORD: 'test-password'
        EMAIL_FROM: 'noreply@newswindon.com'
        ADMIN_EMAIL: 'admin@newswindon.com'

    - name: Build the project
      run: pnpm build
      env:
        VITE_APP_ID: 'newswindon-app'
        VITE_ANALYTICS_ENDPOINT: 'https://analytics.example.com'
        VITE_ANALYTICS_WEBSITE_ID: 'test-id'

    - name: Install Playwright browsers
      run: pnpm exec playwright install --with-deps

    - name: Run E2E Tests
      run: pnpm test:e2e
      env:
        VITE_APP_ID: 'newswindon-app'
        JWT_SECRET: 'test-secret-key-at-least-32-chars-long-for-ci'
        DATABASE_URL: 'mysql://root:password@localhost:3306/newswindon'
        OAUTH_SERVER_URL: 'http://localhost:3000'
        OWNER_OPEN_ID: 'test-owner-id'

    - name: Upload Playwright Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 7

    - name: PR Feedback
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const { job, payload } = context;
          const status = job.status === 'success' ? '✅' : '❌';
          const body = `${status} CI Pipeline finished with status: ${job.status}.`;
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
